
# Trovemat Kiosk User Guide

## Файлы настроек киоска (configs)
Файлы фастроек киоска хранятся в директории configs.
* config.xml - настройки киоска.
* menu.xml - структура меню.
* operators.xml - список операторов.
* *_lastgood.xml - последний успешно загруженный файл.
* *_lastbad.xml - последний неудачно загруженный файл.
	
Пример:
1. Если config.xml - правильный. После успешной проверки киоск его скопирует и сохранит под именем config_lastgood.xml.
1. Если operators.xml - неправильный. После неуспешной проверки киоск его скопирует и сохранит под именем operators_lastbad.xml. Далее попробует загрузить operators_lastgood.xml, и если он окажется валидным: скопирует operators_lastgood.xml и сохранит под именем operators.xml

## Настройки киоска (config.xml)
	
Пример конфига:
``` XML
<config>
    <parameters>
        <point_id>1</point_id>
        <extended_logging>false</extended_logging>
    </parameters>
        <gateways>
		<trovemat_gateway type="trovemat" url="bapi.trovemat.com" username="demo" password="demo" check="true" pay="true" info="false" tasks="true" tasks_interval="300" />
		<tox_messanger type="tox_text" check="false" pay="false" info="true" tasks="true" >
			<friends>
				<friend_1 tox_id="" />
			</friends>
			<nodes>				
				<node_1 ip="144.76.60.215" port="33445" tox_id="04119E835DF3E78BACF0F84235B300546AF8B936F035185E2A8E9E0A67C8924F" />
				<node_3 ip="128.199.199.197" port="33445" tox_id="B05C8869DBB4EDDD308F43C1A974A20A725A36EACCA123862FDE9945BF9D3E09" />
			</nodes>
		</tox_messanger>	
	</gateways>
    <payments>
    	<gateway>trovemat</gateway>
        <currency>USD</currency>
    </payments>
    <interface wait_init_devices="2" />
    <terminal>
        <init>
            <app>./startup.sh</app>
            <args></args>
            <timeout></timeout>
        </init>
    </terminal>
    <peripherals>
        <barcodereader model="" port="" baudrate="9600" extended_logging="config.parameters.extended_logging" show_errors="0" />
        <printer model="" port="" baudrate="9600" extended_logging="config.parameters.extended_logging" show_errors="0" charset_code_table="0" />
        <validator model="" port="" baudrate="9600" extended_logging="config.parameters.extended_logging" show_errors="0" />
    </peripherals>
    <point_info>
        <dealer_name name="Дилер" value="Рога и Копыта" />
    </point_info>
</config>
```

> Значения по умолчанию.
Если параметр в конфиге отсутствует или имеет значение "default" - берется его значение по умолчанию. 

> Ccылки на значения.
Если значение параметра начинается на "config." - киоск трактует его как ссылку. В примере выше атрибут extended_logging тега barcodereader задан через ссылку на значение extended_logging в parameters.`

* parameters - общие параметры терминала.
    * extended_logging - дополнительное логирование:
   	 > **!!! ВНИМАНИЕ ! При включении дополнительного логгирования в лог-файлы будут попадать абсолютно все данные, передаваемые устройству, в том числе секретные данные, не предназначенные для логгирования !!!** 
		- **"false"** (значение по умолчанию) - отключено.
		- **"true"** - включено.
    * point_id - номер точки. Значение по умолчанию - 0.
* payments - параметры платежей по умолчанию. Могут быть переопределены для каждого оператора на шаге "money_entry" в operators.xml. Описание параметров в разделе "Операторы".
    * gateway - значение по умолчанию - "".
    * currency - значение по умолчанию - "USD".
    * limit_min - значение по умолчанию - "0".
    * limit_max - значение по умолчанию - "1000000".
    * payment_type - значение по умолчанию - "mut_price".
    * fee - по умолчанию - отсутствует.
    * check_name - значение по умолчанию - "default.chq".
    * failed_check_name - значение по умолчанию - "default_failed.chq".
* interface
    * wait_init_devices - переход со страницы инициализации на страницу меню.
		- **"0"** (значение по умолчанию) - не дожидаясь инициализации устройств.
		- **"1"** - ждать завершение инициализации устройств с параметром "show_errors" не равным "0".
		- **"2"** - ждать завершение инициализации всех устройств.
* terminal
    * init - тег, описывающий параметры для запуска приложения при старте киоска
        * app - строка - приложение, которое киоск запустит отдельным процессом при старте.
        * args - строка - аргументы командной строки
        * timeout - целое число - время ожидания старта и завершения приложения в мсек. Если указано значение -1 - то таймаут не контролируется.
* peripherals    
    * model - модель устройства. Если устройства нет, оставить значение пустым. Значение по умолчанию - "".
    * port - номер последопательного порта, используемого данным устройством. Значение по умолчанию - "".
    * baudrate - скорость COM порта, используемого данным устройством. Значение по умолчанию - "9600".
    * extended_logging - дополнительное логирование, в том числе, всех команд передаваемых в COM-порт устройству.  
		> **!!! ВНИМАНИЕ ! При включении дополнительного логгирования в лог-файлы будут попадать абсолютно все данные, передаваемые устройству, в том числе секретные данные, не предназначенные для логгирования !!!**  
		- **"false"** (значение по умолчанию) - отключено.
		- **"true'** - включено.
    * show_errors - при обнаружении неисправностей в данном устройстве, показывать экран "Киоск не работает".
		- **"0"** (значение по умолчанию) - отключено.
		- **"1"** - только если нет активных платежей или оставшейся наличности.
		- **"2"** - переключать сразу.
* validator - Поддерживаемые модели (указывается в атрибуте model):
    - **"mei_ebds"** - купюроприёмник MEI. Поддерживается перепрошивка киоском. При запуске киоска проверяется наличие файла 'validator.bin' (прошивка) в корневой дирректории и если таковой имеется производится попытка прошивки. После успешной прошивки файл удаляется. Поддержвает следующие параметры:
		- **enabled_currencies** - список валют, которые может принимать купюроприёмник. Строка с разделителем "," (запятая), в строке через разделитель указываются трёхбуквенные наименования валют по стандарту ISO-4217. Пустое значение означает приём всех валют, которые поддерживаются прошивкой купюроприёмника. Значение по умолчанию - пустая строка.
    - **"test_validator"** - тестовый программно-эмулируемый купюроприемник для отладочных целей.
* printer - Поддерживаемые модели (указывается в атрибуте model):
	- **"tg2480"** - чековый принтер CUSTOM TG2480. В некоторых случаях (зависит от версии прошивки ПО принтера) будет также поддерживаться принтер Custom VKP 80 II с такими же настройками.
	- **"test_printer"** - тестовый программно-эмулируемый принтер для отладочных целей.
    * charset_code_table - номер таблицы символов, используемой при печати. Значение по умолчанию - "0".
        * Для tg2480:
            - **"0"** - CP437 (US)
            - **"2"** - CP850 (Multilingual)
            - **"3"** - CP860 (Portuguesse)
            - **"4"** - CP863 (Canadian-French)
            - **"5"** - CP865 (Nordic)
            - **"17"** - CP866 (Cyrillic)
            - **"19"** - CP858 (for Euro symbol 213)
		
* point_info - В данном разделе можно задать неограниченное количество системных полей с любыми именами. Эти поля можно использовать при печати чеков и запросах к шлюзам. "Id" поля задается вида _INFO_*, где * - имя поля заглавными буквами. Имя и значение могут быть заданы атрибутами "name" и "value". Пример: <dealer_name name="Диллер" value="Рога и Копыта" /> будет преобразовано в системное поле с id="_INFO_DEALER_NAME", name="Дилер" и value="Рога и Копыта".

* gateways В данном разделе можно задать неограниченное количество тегов, описывающих подключение к различным серверам.
Название вложенного тега - это название шлюза, которое можно использовать в шагах (см. тег "step" атрибут "gateway"). Для каждого шлюза указыватся следующие аттрибуты:
	- check - разрешение на использование данного шлюза для информационных запросов с киоска
	- pay - разрешение на использование данного шлюза для платежных запросов с киоска
	- info - отправка в шлюз информационных сообщений с киоска
	- tasks - разрешение на выполнение команд со шлюза
	- type - наименование типа шлюза. Доступные типы: 
		- **"trovemat"** - шлюз для доступа к api.trovemat.com.
		Для данного шлюза указываются следующие дополнительные аттрибуты:
			- url - адрес сервера		
			- username - учётная запись для доступа
			- password - пароль для доступа к API
			- tasks_interval - интервал опроса шлюза на предмет новых задач
		- **"tox_text"** - шлюз для доступа к терминалу через любой tox-мессеннджер.
		Для данного шлюза указываются следующие дополнительные теги:
			- friends - список доверенных tox-аккаунтов. Наименование вложенного тега - имя такого аккаунта.
				- tox_id - идентификатор tox-аккаунта
			- nodes - список узлов для подключения к tox-сети. Наименование вложенного тега - имя такого узла.
				 - ip - ip адрес узла
				 - port - порт узла
				 - tox_id - публичный ключ узла
    
## Меню (menu.xml)

Пример конфига:
``` XML
<?xml version="1.0" encoding="utf-8"?>
<group id="0" name="Выберите оператора" image="" background="" columns="4" rows="2" scale="1" >
	<operator id="1" name="MTS" image="mts.gif" />
	<operator id="2" name="Beeline" image="beeline.gif" />
	<group id="1" name="Megafon" image="megafon.gif" background="" columns="4" rows="2" scale="1" >
		<operator id="3" name="Megafon Moscow" image="megafon.gif" />
		<operator id="4" name="Megafon Sochi" image="megafon.gif" />
	</group>
	<operator id="5" name="Теле2" image="tele2.gif" visible="0" />
</group>
```
Меню состоит из групп и операторов, соответственно в конфиге разрешены только теги 'group' и 'operator'. Обязательным для всех элементов является только аттрибут 'id', остальные могут отсутствовать. Все операторы, присутствующие в меню, должны быть и в списке операторов (operators.xml).

Общие атрибуты для групп и операторов.
* "id" - уникальный идентификатор. У групп значение "0" должно быть у главной группы, которая отображается первой.
* "name" - имя группы для отображения.
* "image" - изображение для данного элемента.
* "visible" - отображение элемента меню. Значение по умолчанию - "1".

Аттрибуты групп.	
* "background" - фоновое изображение для таблицы элементов меню.
* "columns" - количество столбцов на странице (таблица растягивается на все свободное пространство). Значение по умолчанию - "1".
* "rows" - количество строк на странице. Значение по умолчанию - "1".
* "scale":
	- **"true"** (значение по умолчанию) - пропорционально размеру исходного изображения подгоняет его под размер получившийся ячейки.
	- **"false"** - подгон изображения происходит только если оно выходит за пределы ячейки.

## Список операторов (operators.xml)

* operator - оператор. Описывает схему проведения платежа.	
	* step - шаг платежа.
		* type - тип шага платежа. Обязательный параметр. Значение по умолчанию отсутствует. Допустимые значения:			
			- **"data_entry"** - ввод данных платежа пользователем.
			- **"change_currency"** - выбор валюты. Пользователь сам выбирает валюту из списка. 
				* mode - Возможные значения (способы формирования списка валют):
					1. **"USD,RUB,EUR"** - Перечисление списка валют через запятую.
					1. **"NOTE_VAL"** (значение по умолчанию) - все валюты, поддерживаемые купюроприемником.			
			- **"money_entry"** - внесение денег пользователем. Так же тут задаются параметры платежей, значения по умолчанию для которых заданы в conig.xml -> payments.
				* payment_type - тип платежа. Возможные значения:
					- **"mut_price"** - цена не фиксированна.
					- **"fix_price"** - цена фиксированна.
				* price - цена (для фиксированного платежа). Значение по умолчанию отсутствует. Обязательно к заполнению при **type="fix_price"**.
				* currency - валюта платежа, трехбуквенный код по ISO 4217.
				* limit_min - минимальная сумма для приёма наличных.
				* limit_max - максимальная сумма для приёма наличных.
				* fee - коммиссия, задается промежутками по диапазону принятых денег.
					* part - один из диапазонов, для каждого из которых задается своя коммиссия.
						* min - порог, с которого начинает взыматься данная коммиссия.
						* percent - процентная составляющая коммиссии.
						* fix - фиксированная составляющая коммиссии.
						Пример:
						От 0 до 50 у.е. - взымать коммиссию в размере 2% + 2.01 у.е.
						От 50 и выше - взымать коммиссию в размере 1%.
						``` XML
						<fee>
							<part min="0" percent="2" fix="2.01" />
							<part min="50" percent="1" fix="0" />
						</fee>
						```
			- **"check"** - запрос к шлюзу без платежа.
				* server - Наименование сервера, на который необходимо отправлять запрос. Конкретные параметры для доступа к серверу находятся в conig.xml -> network -> <НАИМЕНОВАНИЕ СЕРВЕРА>
				* path - строка запроса (адрес). Например: "/api/Method"
				* method - метод запроса. Возможные значения:
					- **"POST"** - будет отправлен POST запрос. Тело запроса будет содержать JSON-объект, составленный из полей, описанных в тегах "request_field" данного шага.
					- **"GET"** - будет отправлен GET-запрос. Тело запроса будет пустым. URL запроса будет составленн из полей, описанных в тегах "request_field" данного шага.
			- **"pay"** - запрос к шлюзу и осуществление платежа. Параметры данного шага аналогичны параметрами шагов с типом "check"
			- **"print"** - печать чека.
				* check_name - имя файла шаблона чека, значение по умолчанию в config.xml.
			- **"message"** - сообщение пользователю.
		- request_field - тег - используется для шагов с типом "check" и "pay" как поле запроса:
			- id - идентификатор поля. Если содержит символ "." (точка) - то в запросе с типом method="POST" данный параметр будет сохраняться как вложенные элемента JSON-объекта. Например, если указан параметр parameters.token то будет отправлен следующий JSON объект в теле запроса: {"parameters" : {"token" : "123123123123"}}
			- value - содержит значение параметра запроса. Внутри значения можно записать "ссылку" на данные, полученные на другом шаге (от пользователя или от шлюза). Ссылка на поле, введённое клиентом, описывается как "|fi_\<Значение атрибута id тега field\>|". Ссылка на поле, полученное от шлюза, описывается как : "|\<НАИМЕНОВАНИЕ_ПАРАМЕТРА\>|". Например, если был выполнен шаг с типом **"data_entry"** и на этом шаге клиент ввёл значение для поля с id="2", то значение может выглядеть как "001-|fi_2|" - в этом случае если клиент ввёл значение "123" на сервер будет отправлена строка "001-123".
		- receive_field - поле, которое присылает шлюз в ответе на запрос.
			- id - имя параметра в ответе от сервера. Также в текущей клиентской сессии создаётся парамер с данным именем. Данное имя будет актуально только в течении текущей клиентской сессии. Данное имя может быть использовано в ссылке. Например, шлюз в ответе присылает поле с наименованием "buy". В шаге будет указано "...<receive_field id="buy" name="COURSE" />...". Далее в любом другом шаге, например в теге "request_field" можно использовать значение данного параметра путём указания строки "|buy|" - вместо этой строки будет подставлено конкретное значение, полученное от шлюза.
			- name - наименование параметра внутри данного сценария. 

## Шаблоны чеков (*.chq)

В шаблонах чеков можно использовать переменные.

Правила записи переменных:
1. Имя переменной заключено в знаки процента "%".
1. В имени переменной можно использовать латинские заглавные буквы, цифры, знак подчеркивания.
1. После имени переменной могут идти параметры к переменной.
	Правила записи параметров к переменным:
	1. Перед каждым параметром должно стоять двоеточие ":".
	1. Параметры должны идти строго в порядке их перечисления ниже.

Доступные параметры:
1. Заглавная латинская буква "N" или "V". Определяет имя ("N") или значение ("V") поля необходимо вывести. Значение по умолчанию: "V".
1. Число, задает длину выводимого значения. Значение переменной будет обрезано или дополнено пробелами до указанной длины.
1. Заглавная латинская буква "R" или "L". Опеределяет справа ("R") или слева ("L") необходимо обрабатывать поле (убирать лишние символы или добавлять пробелы до нужной длины). Значение по умолчанию: "L".

Пример обработки и вывода переменных.  
Шаблон:
```
--------------------------------
%SUM%
%SUM:N%: %SUM:V%
Значение поля сумма: %SUM:V%
%SUM:N:3:R%.: %SUM:V:5%
%SUM:20%
--------------------------------
```
Пусть задано следующее поле:  
id="SUM" name="Сумма" value="1234567890"
Тогда результат будет следующим:
```
--------------------------------
1234567890
Сумма: 1234567890
Значение поля сумма: 1234567890
Сум.: 67890
          1234567890
--------------------------------
```
Пользовательские переменные.
1. Не могут начинаться со знака подчеркивания "_".
1. В пользовательские переменные добавляются все поля операторов (field). Идентификаторы задаются вида "fi_id" (fi_23 для field id="23").

Системные переменные.
Переменные, начинающиеся со знака подчеркивания "_" являются системными. Доступны следующие системные переменные:
* _FIELDS_FOR_PRINT - выводит все пользовательские переменные, у которых значение "print" равно "1", в виде набора строк: "имя_переменной: значение_переменной".
* _INFO_* - поля, заданные в разделе config.xml -> config -> point_info.
* _TERMNUMBER - номер терминала (config.xml -> config -> parameters -> point_id)
* _DATETIME - дата и время
* _ACCEPTED - количество принятых наличных денежных средств
* _COMISSION - комиссия
* _ENROLLED - количество денежных средств к зачислению на счёт клиента
* _CURRENCY - трехбуквенный код валюты платежа
* _OPNAME - имя оператора платежа

Только для чека инкассации:
* _INCS_CASSETTE - номер текущей кассеты с наличностью (в настоящее время заменяется на пустую строку)
* _INCS_NEXT_CASSETTE - номер новой кассеты (в настоящее время заменяется на пустую строку)
* _INCS_LAST_INCASSATION_TIME - предыдущее время инкассации
* _INCS_INCASSATION_TIME - время текущей инкассации
* _INCS_MONEY_INFO - подробная информация о принятых купюрах

## Логи (Logs/*.log)

Хранятся в директории logs, расположенной на одном уровне с приложением. Имя файла включает объект логгирования и дату. Каждая строка в файле состоит из "типа сообщения", времени, идентификатора потока, номера строки кода и текста сообщения.

Объекты логгирования:
* Kiosk - лог с основной информацией.
* Main - критическая информация о работе программы, в случае отсутствия ошибок пуст.
* Device_* - логи устройств, где * - имя устройства.
	
Тип сообщения:
* INF - простое, можно не обращать внимания, пока всё идет хорошо.
* WRN - необходимо обратить внимаение, возможно что-то пошло не так, как планировалось.
* ERR - произошла ошибка.
* EXT - расширенная информация, выводится только когда включена соответствующая настройка в конфиге киоска.
	
## Эмуляция устройств

В целях тестирования ПО вместо реальных устройств можно включать их эмуляцию. Для этого в настройках типа модели устройства необходимо указать специальное имя. Для эмуляции событий устройств нужно нажать на клавиатуре последовательно две клавиши из диапазона (F1 - F12). Первым нажатием выбирается устройство, вторым - событие данного устройства. 

* Validator.
    * model - "test_validator"
    * клавиша - "F9"
    * события:
        * F1 - устройство вышло из строя.
        * F2 - устройство работает.
        * F3 - кассета убрана.
        * F7 - внести 1 у.е. (1 копейка для RUB)
        * F8 - внести 10 у.е. (10 копеек для RUB)
        * F9 - внести 100 у.е. (1 рубль для RUB)
        * F10 - внести 500 у.е. (5 рублей для RUB)
        * F11 - внести 1000 у.е. (10 рублей для RUB)
        * F12 - внести 5000 у.е. (50 рублей для RUB)
		
* Printer - Печатает чеки в файлы (test_check_*.txt)
    * model - "test_printer"
    * клавиша - "F11"
    * события:
        * F1 - устройство вышло из строя.
        * F2 - устройство работает.

## Сервисные сочетания клавиш
* F1 + F1 - закрытие киоска (остановка процесса киоска)
* F1 + F2 - переход в сервисное меню
* F9 + ... - виртуальный валидатор - см. "Эмуляция устройств"
* F10 + ... - виртуальный сканер штрихкодов - см. "Эмуляция устройств"
* F11 + ... - виртуальный принтер - см. "Эмуляция устройств"

## Особенности работы приложения в демонстрационном режиме
1. SMS отправляется с нашего сервера через шлюз digital-direct.ru от имени "Trovemat"
1. Платежи проходят через сервер [jetcrypto.com](https://jetcrypto.com/)
1. На экране поверх приложения выводится надпись о том что это демо-версия.
1. Приложение работает 10 минут, затем выключается (может быть увеличено по отдельному запросу на sales@trovemat.com).

## Особенности работы приложения
1. Номер телефона вводится в международном формате без символа "+" в начале. Например для России надо будет вводить "79261234567".
1. На главной странице курсы берутся с сайта coinmarketcap.com
1. Доступ к биржам осуществляется по токену, который надо прописывать в файле configs/operators.xml для соответствующего поля request_field:
	1. BitLish: в шаге с id="0" и в шаге с id="7" у параметра "request_field" id="parameters.token" указывается токен для доступа к API.		
	1. EXMO: 
		- в шаге с id="0" у параметра "request_field" id="parameters.publicKey" указывает API key, в параметре "request_field" id="parameters.secretKey" указывается API secret.
		- в шаге с id="7" у параметра "request_field" id="params" в параметре указывается API key в атрибуте "publicKey" JSON-объекта, API secret указывается в атрибуте "secretKey" JSON-объекта.
	1. Poloniex: в шаге с id="7" у параметра "request_field" id="params" в параметре указывается POLONIEX API Key в атрибуте "publicKey" JSON-объекта, POLONIEX API Secret указывается в атрибуте "secretKey" JSON-объекта.

## Калибровка TOUCH-SCREEN

Откалибровать сенсорный дисплей: 
1. Выполнить команду 
    ```Shell
    sudo apt install xinput-calibrator && xinput_calibrator --list
    ```
    и посмотреть id Тачскрина.
1. Выполнить команду 
    ```Shell 
    xinput_calibrator --device <ИДЕНТИФИКАТОР УСТРОЙСТВА, ОПРЕДЕЛЁННЫЙ НА ПЕРВОМ ШАГЕ>
    ```
1. Чтобы сохранить калибровку, нужно скопировать полученную после калибровки информацию (начиная с Section "InputClass" и заканчивая EndSection, включая эти фразы)
1. Выполнить команду 
    ```Shell 
    sudo nano /usr/share/X11/xorg.conf.d/99-calibration.conf
    ```
    Возможно, необходимо будет предварительно нажать "Y", чтобы подтвердить действие, соответствующая подсказка будет на экране терминала.
1. Вставить скопированную информацию, сохранить запись (CTRL+"O" (буква O англ.)) и подтвердить клавишей ENTER, далее выход (CTRL + X)

## Настройка списка администраторов для управления киоском

Для управления ПО Trovemat может использоваться любй мессенджер, поддерживающий протокол [Tox](https://tox.chat/). Управление списком пользователей, которые имеют возможность взаимодействовать с киоском, осуществляется следующим образом:
1. Перейти в сервисный режим (см. [Сервисные сочетания клавиш](#Сервисные-сочетания-клавиш))
1. Нажать кнопку "Список администраторов"
1. Открыть QR-код, содержащий tox-id пользователя, которого надо добавить в список администраторов киоска
1. Сканировать открытый QR-код на киоске
1. Подтвердить в мессенджере администратора запрос на добавления в список контактов от ПО Trovemat

Управление ПО Trovemat с использованием мессенджера:
1. Можно отправить команду
	```
	help
	```
	в ответ киоск пришлёт список команд, которые он может выполнять
1. Для получения подробного описания по отдельной команде, необходимо отправить сообщение вида
	```
	help 'НАИМЕНОВАНИЕ КОМАНДЫ'
	```
	Например, команда:
	```
	help 'status'
	```
	В результате выполнения этой команды ПО Trovemat пришлёт расширенное описание команды "status"
